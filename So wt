local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local RunService = game:GetService("RunService")

local gui = Instance.new("ScreenGui")
gui.Name = "AimGui"
gui.ResetOnSpawn = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- دائرة FOV
local circle = Instance.new("Frame")
circle.Size = UDim2.new(0,150,0,150)
circle.AnchorPoint = Vector2.new(0.5,0.5)
circle.Position = UDim2.new(0.5,0,0.5,0)
circle.BackgroundTransparency = 1
circle.Parent = gui

local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(1,0)
uicorner.Parent = circle

local circleStroke = Instance.new("UIStroke")
circleStroke.Thickness = 2
circleStroke.Color = Color3.fromRGB(255,255,0)
circleStroke.Parent = circle

-- عدد الطلقات
local shotsBox = Instance.new("TextBox")
shotsBox.Size = UDim2.new(0,80,0,30)
shotsBox.Position = UDim2.new(0.5,-40,0.8,-40)
shotsBox.AnchorPoint = Vector2.new(0.5,1)
shotsBox.PlaceholderText = "عدد الطلقات"
shotsBox.Text = "1"
shotsBox.BackgroundColor3 = Color3.fromRGB(255,255,255)
shotsBox.Parent = gui
Instance.new("UICorner", shotsBox)

-- زر إطلاق (قابل للسحب)
local shootBtn = Instance.new("TextButton")
shootBtn.Size = UDim2.new(0,120,0,50)
shootBtn.Position = UDim2.new(0.5,-60,0.8,0)
shootBtn.AnchorPoint = Vector2.new(0.5,0)
shootBtn.Text = "إطلاق"
shootBtn.TextScaled = true
shootBtn.BackgroundColor3 = Color3.fromRGB(255,50,50)
shootBtn.TextColor3 = Color3.new(1,1,1)
shootBtn.Parent = gui
Instance.new("UICorner", shootBtn)

-- كود السحب للزر
local dragging = false
local dragInput, dragStart, startPos

local function update(input)
	local delta = input.Position - dragStart
	shootBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
		startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

shootBtn.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = shootBtn.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

shootBtn.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		update(input)
	end
end)

-- خط التصويب
local line = Drawing and Drawing.new("Line")
if line then
	line.Color = Color3.fromRGB(255,0,0)
	line.Thickness = 3
	line.Visible = false
end

-- تحديد أقرب لاعب داخل الدائرة
local function getClosestPlayer()
	local closest,dist = nil,math.huge
	local center = Vector2.new(circle.AbsolutePosition.X + circle.AbsoluteSize.X/2,
		circle.AbsolutePosition.Y + circle.AbsoluteSize.Y/2)
	local radius = circle.AbsoluteSize.X/2
	for _,plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local hrp = plr.Character.HumanoidRootPart
			local screenPos,onScreen = Camera:WorldToViewportPoint(hrp.Position)
			if onScreen then
				local d = (Vector2.new(screenPos.X,screenPos.Y)-center).Magnitude
				if d < dist and d < radius then
					closest = plr
					dist = d
				end
			end
		end
	end
	return closest
end

-- تحديث الخط باستمرار
RunService.RenderStepped:Connect(function()
	local plr = getClosestPlayer()
	if plr and plr.Character:FindFirstChild("Head") then
		local headPos = Camera:WorldToViewportPoint(plr.Character.Head.Position)
		local center = Vector2.new(circle.AbsolutePosition.X + circle.AbsoluteSize.X/2,
			circle.AbsolutePosition.Y + circle.AbsoluteSize.Y/2)
		if line then
			line.From = center
			line.To = Vector2.new(headPos.X,headPos.Y)
			line.Visible = true
		end
	else
		if line then line.Visible = false end
	end
end)

-- دالة الإطلاق باستخدام الإحداثيات الديناميكية
local function shootAt(plr, times)
	if not plr or not plr.Character or not plr.Character:FindFirstChild("Head") then return end

	local char = LocalPlayer.Character
	if not char or not char:FindFirstChild("Head") then return end

	local myHead = char.Head
	local targetHead = plr.Character.Head

	for i = 1, times do
		-- الإحداثيات الفعلية:
		local origin = myHead.Position
		local direction = (targetHead.Position - myHead.Position).Unit -- اتجاه التصويب

		local args = {
			"Shoot",
			targetHead,
			origin,
			direction,
			Enum.Material.Plastic
		}

		ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Packages"):WaitForChild("_Index")
			:WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net")
			:WaitForChild("RE/GunRemote"):FireServer(unpack(args))

		task.wait(0.05)
	end
end

-- زر الإطلاق
shootBtn.MouseButton1Click:Connect(function()
	local plr = getClosestPlayer()
	local times = tonumber(shotsBox.Text) or 1
	if plr then
		shootAt(plr, times)
	end
end)
