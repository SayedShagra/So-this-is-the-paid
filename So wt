-- ⬛ نظام تحكم بالدرون + إطلاق + خط + دائرة + زر رجوع
-- النسخة المطلوبة بدون GUI متطور

local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local camera = workspace.CurrentCamera
local mouse = player:GetMouse()

-- عناصر واجهة المستخدم
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "DroneSystem"

-- دائرة الاستهداف
local circle = Instance.new("Frame", gui)
circle.Size = UDim2.new(0, 40, 0, 40)
circle.Position = UDim2.new(0.5, -20, 0.5, -20)
circle.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
circle.BackgroundTransparency = 0.7
circle.BorderSizePixel = 0
circle.AnchorPoint = Vector2.new(0.5, 0.5)
circle.Visible = true
circle.ZIndex = 2
circle.ClipsDescendants = true
circle.Parent = gui
Instance.new("UICorner", circle).CornerRadius = UDim.new(1, 0)

-- خط التتبع
local line = Instance.new("Frame", gui)
line.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
line.BorderSizePixel = 0
line.Size = UDim2.new(0, 2, 0, 0)
line.AnchorPoint = Vector2.new(0.5, 0)
line.Visible = true
line.ZIndex = 1

-- أزرار التحكم
local controlFrame = Instance.new("Frame", gui)
controlFrame.Position = UDim2.new(0.05, 0, 0.4, 0)
controlFrame.Size = UDim2.new(0, 120, 0, 200)
controlFrame.BackgroundTransparency = 1

local directions = {
	{ name = "أمام", key = Enum.KeyCode.W },
	{ name = "خلف", key = Enum.KeyCode.S },
	{ name = "يمين", key = Enum.KeyCode.D },
	{ name = "يسار", key = Enum.KeyCode.A },
}

local buttons = {}

for i, dir in ipairs(directions) do
	local b = Instance.new("TextButton", controlFrame)
	b.Size = UDim2.new(1, 0, 0, 40)
	b.Position = UDim2.new(0, 0, 0, (i - 1) * 45)
	b.Text = dir.name
	b.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	b.TextColor3 = Color3.new(1, 1, 1)
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 10)
	buttons[dir.key] = b
end

-- زر الرجوع
local exitButton = Instance.new("TextButton", gui)
exitButton.Size = UDim2.new(0, 100, 0, 40)
exitButton.Position = UDim2.new(0.9, 0, 0.9, 0)
exitButton.Text = "رجوع"
exitButton.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
exitButton.TextColor3 = Color3.new(1, 1, 1)
Instance.new("UICorner", exitButton).CornerRadius = UDim.new(0, 10)

-- إعدادات
local droneActive = false
local drone = Instance.new("Part", workspace)
drone.Name = "Drone"
drone.Size = Vector3.new(2, 1, 2)
drone.Transparency = 1
drone.Anchored = false
drone.CanCollide = false
drone.CFrame = char.HumanoidRootPart.CFrame

-- تفعيل التحكم بالدرون
for key, btn in pairs(buttons) do
	local moving = false
	btn.MouseButton1Down:Connect(function()
		if not droneActive then return end
		moving = true
		while moving do
			if key == Enum.KeyCode.W then
				drone.CFrame = drone.CFrame * CFrame.new(0, 0, -1)
			elseif key == Enum.KeyCode.S then
				drone.CFrame = drone.CFrame * CFrame.new(0, 0, 1)
			elseif key == Enum.KeyCode.A then
				drone.CFrame = drone.CFrame * CFrame.new(-1, 0, 0)
			elseif key == Enum.KeyCode.D then
				drone.CFrame = drone.CFrame * CFrame.new(1, 0, 0)
			end
			task.wait(0.02)
		end
	end)
	btn.MouseButton1Up:Connect(function()
		moving = false
	end)
end

-- زر الرجوع
exitButton.MouseButton1Click:Connect(function()
	droneActive = not droneActive
	for _, btn in pairs(buttons) do
		btn.Visible = droneActive
	end
	exitButton.Text = droneActive and "رجوع" or "التحكم بالدرون"
end)

-- تتبع الهدف الأقرب
game:GetService("RunService").RenderStepped:Connect(function()
	local nearest, dist = nil, math.huge
	for _, p in pairs(game.Players:GetPlayers()) do
		if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local pos = p.Character.HumanoidRootPart.Position
			local screenPos, onScreen = camera:WorldToViewportPoint(pos)
			if onScreen then
				local mousePos = Vector2.new(mouse.X, mouse.Y)
				local d = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
				if d < dist then
					dist = d
					nearest = p
				end
			end
		end
	end
	if nearest and nearest.Character and nearest.Character:FindFirstChild("Head") then
		local startPos = (droneActive and drone.Position) or char.Head.Position
		local endPos = nearest.Character.Head.Position
		local startScreen = camera:WorldToViewportPoint(startPos)
		local endScreen = camera:WorldToViewportPoint(endPos)
		local dir = (Vector2.new(endScreen.X, endScreen.Y) - Vector2.new(startScreen.X, startScreen.Y))
		local len = dir.Magnitude
		local mid = (Vector2.new(startScreen.X, startScreen.Y) + Vector2.new(endScreen.X, endScreen.Y)) / 2

		line.Position = UDim2.new(0, mid.X, 0, mid.Y)
		line.Size = UDim2.new(0, 1, 0, len)
		line.Rotation = math.deg(math.atan2(dir.Y, dir.X)) + 90
	end
end)
	local dirUnit = dirVec.Unit

	local args = {
		"Shoot",
		toHead,
		fromPos,
		dirUnit,
		Enum.Material.Plastic
	}
	if shootRemote then
		pcall(function() shootRemote:FireServer(unpack(args)) end)
	end
end

-- shoot button click and hold-to-spam
local shooting = false
local holdStart = 0
shootBtn.MouseButton1Down:Connect(function()
	holdStart = tick()
	shooting = true
	-- single immediate shot
	buildAndFire(currentTarget)
	-- spam if hold
	spawn(function()
		while shooting do
			if tick() - holdStart > 0.5 then
				buildAndFire(currentTarget)
				task.wait(0.12)
			else
				task.wait(0.03)
			end
		end
	end)
end)
shootBtn.MouseButton1Up:Connect(function() shooting = false end)
-- touch support
shootBtn.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.Touch then shooting = false end
end)

-- exit button
exitBtn.MouseButton1Click:Connect(function()
	-- restore camera and cleanup
	if player.Character and player.Character:FindFirstChild("Humanoid") then
		camera.CameraSubject = player.Character.Humanoid
		camera.CameraType = Enum.CameraType.Custom
	end
	if gui and gui.Parent then gui:Destroy() end
	if drone and drone.Parent then drone:Destroy() end
end)

-- cleanup if character removed
player.CharacterRemoving:Connect(function()
	if gui and gui.Parent then gui:Destroy() end
	if drone and drone.Parent then drone:Destroy() end
end)
